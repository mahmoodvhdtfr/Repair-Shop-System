<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุณุช ูุดุชุฑุงู - ุณุณุชู ุชุนูุฑฺฏุงู</title>
	<link rel="stylesheet" href="/static/style.css">
</head>
<body class="customers-page">
    <div class="container">
        <header>
            <h1>๐ ูุฑู ุงูุฒุงุฑ ูุฏุฑุช ุชุนูุฑฺฏุงู ููุงุฒู ุฎุงูฺฏ ฺุงุจฺฉ ุงูฺฉุชุฑููฺฉ</h1>
            <nav>
                <a href="/" class="nav-link">๐ ุฏุงุดุจูุฑุฏ</a>
                <a href="/add-customer" class="nav-link">๐ค ุซุจุช ุฏุณุชฺฏุงู ุฌุฏุฏ</a>
                <a href="/customers" class="nav-link active">๐ ูุณุช ูุดุชุฑุงู</a>
                <a href="/reports" class="nav-link">๐ ฺฏุฒุงุฑุดโูุง</a>
                <a href="/import-export" class="nav-link">๐ค ุงููพูุฑุช/ุงฺฉุณูพูุฑุช</a>
            </nav>
        </header>

        <main>
            <div class="customers-section">
                <div class="section-header">
                    <div class="header-icon">๐ฅ</div>
                    <h2>ูุฏุฑุช ูุดุชุฑุงู</h2>
                    <p>ูุดุงูุฏูุ ุฌุณุชุฌู ู ูุฏุฑุช ุงุทูุงุนุงุช ูุดุชุฑุงู</p>
                </div>

                <!-- ุขูุงุฑ ุณุฑุน -->
                <div class="quick-stats">
                    <div class="stat-card mini">
                        <div class="stat-icon">๐</div>
                        <div class="stat-info">
                            <h3>ฺฉู ูุดุชุฑุงู</h3>
                            <span class="stat-number">{{ customers|length if customers else 0 }}</span>
                        </div>
                    </div>
                    
                    <div class="stat-card mini">
                        <div class="stat-icon">๐ฐ</div>
                        <div class="stat-info">
                            <h3>ุฏุฑุขูุฏ ฺฉู</h3>
                            <span class="stat-number" id="totalIncome">0 ุชููุงู</span>
                        </div>
                    </div>
                    
                    <div class="stat-card mini">
                        <div class="stat-icon">๐</div>
                        <div class="stat-info">
                            <h3>ุฏุฑ ุญุงู ุชุนูุฑ</h3>
                            <span class="stat-number" id="activeRepairs">0</span>
                        </div>
                    </div>
                </div>

                <!-- ุฌุณุชุฌู ู ููุชุฑ -->
                <div class="search-filter-section">
                    <div class="search-box">
                        <form method="GET" class="search-form">
                            <div class="search-input-wrapper">
                                <input type="text" name="search" class="search-input" 
                                       placeholder="๐ ุฌุณุชุฌู ุจุฑ ุงุณุงุณ ูุงูุ ุดูุงุฑู ุชูุงุณุ ฺฉุฏ ูุณูู ุง ููุน ูุณูู..." 
                                       value="{{ request.args.get('search', '') }}">
                                <button type="submit" class="btn btn-primary search-btn">
                                    ุฌุณุชุฌู
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="filter-actions">
                        <button class="btn btn-secondary" onclick="clearSearch()">
                            ๐๏ธ ูพุงฺฉ ฺฉุฑุฏู ุฌุณุชุฌู
                        </button>
                        <a href="/customers" class="btn btn-success">
                            ๐ ุจุงุฑฺฏุฐุงุฑ ูุฌุฏุฏ
                        </a>
                    </div>
                </div>

                <!-- ุฌุฏูู ูุดุชุฑุงู -->
                <div class="table-section">
                    {% if customers %}
                    <div class="table-header">
                        <h3>๐ ูุณุช ูุดุชุฑุงู ({{ customers|length }} ููุฑุฏ)</h3>
                        <div class="table-actions">
                            <button class="btn btn-info" onclick="exportToExcel()">
                                ๐ฅ ุฎุฑูุฌ Excel
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>ุฑุฏู</th>
                                    <th>ูุงู ูุดุชุฑ</th>
                                    <th>๐ ุชูุงุณ</th>
                                    <th>๐ ูุฑูุฏ</th>
                                    <th>๐ ุฎุฑูุฌ</th>
                                    <th>๐ท๏ธ ฺฉุฏ ูุณูู</th>
                                    <th>๐ง ููุน ูุณูู</th>
                                    <th>๐ ูุถุนุช</th>
                                    <th>โ๏ธ ุนููุงุช</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for customer in customers %}
                                <tr class="customer-row">
                                    <td class="row-number">{{ loop.index }}</td>
                                    <td class="customer-name">
                                        <span class="name-link" onclick="showCustomerDetails({{ customer[0] }})">
                                            ๐ค {{ customer[1] or 'ูุงูุดุฎุต' }}
                                        </span>
                                    </td>
                                    <td class="phone-number">
                                        <span class="phone-badge">{{ customer[2] or '-' }}</span>
                                    </td>
                                    <td class="entry-date">
                                        <span class="date-badge">{{ customer[3] or '-' }}</span>
                                    </td>
                                    <td class="exit-date">
                                        {% if customer[4] %}
                                            <span class="date-badge success">{{ customer[4] }}</span>
                                        {% else %}
                                            <span class="status-badge warning">๐ซ ุชุนู ูุดุฏู</span>
                                        {% endif %}
                                    </td>
                                    <td class="device-code">
                                        <span class="code-badge">{{ customer[5] or '-' }}</span>
                                    </td>
                                    <td class="device-type">
                                        <span class="device-badge">{{ customer[6] or '-' }}</span>
                                    </td>
                                    
                                    <td class="status">
                                        {% if customer[4] %}
                                            <span class="status-badge completed">โ ุชฺฉูู ุดุฏู</span>
                                        {% else %}
                                            <span class="status-badge active">๐ ุฏุฑ ุญุงู ุชุนูุฑ</span>
                                        {% endif %}
                                    </td>
                                    <td class="actions">
                                        <div class="action-buttons">
                                            <button class="btn-edit" onclick="editCustomer({{ customer[0] }})" 
                                                    title="ูุฑุงุด ูุดุชุฑ">
                                                โ๏ธ ูุฑุงุด
                                            </button>
                                            <button class="btn-delete" onclick="deleteCustomer({{ customer[0] }}, '{{ customer[1] }}')" 
                                                    title="ุญุฐู ูุดุชุฑ">
                                                ๐๏ธ ุญุฐู
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- ุตูุญูโุจูุฏ -->
                    <div class="pagination">
                        <div class="pagination-info">
                            ููุงุด {{ customers|length }} ููุฑุฏ ุงุฒ ฺฉู ูุดุชุฑุงู
                        </div>
                    </div>

                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">๐ญ</div>
                        <h3>ูฺ ูุดุชุฑโุง ุงูุช ูุดุฏ</h3>
                        <p>
                            {% if request.args.get('search') %}
                                ูุชุฌูโุง ุจุฑุง "{{ request.args.get('search') }}" ูพุฏุง ูุดุฏ.
                            {% else %}
                                ูููุฒ ูฺ ูุดุชุฑโุง ุฏุฑ ุณุณุชู ุซุจุช ูุดุฏู ุงุณุช.
                            {% endif %}
                        </p>
                        <div class="empty-actions">
                            <a href="/add-customer" class="btn btn-primary">
                                โ ุซุจุช ุงููู ูุดุชุฑ
                            </a>
                            {% if request.args.get('search') %}
                                <button class="btn btn-secondary" onclick="clearSearch()">
                                    ๐๏ธ ูพุงฺฉ ฺฉุฑุฏู ุฌุณุชุฌู
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <!-- Modal ุจุฑุง ููุงุด ุงุทูุงุนุงุช ูุดุชุฑ -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>๐ ุงุทูุงุนุงุช ฺฉุงูู ูุดุชุฑ</h2>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="customerDetails" class="customer-details">
                    <!-- ุงุทูุงุนุงุช ูุดุชุฑ ุงูุฌุง ููุงุด ุฏุงุฏู ูโุดูุฏ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ุจุฑุง ูุฑุงุด ูุดุชุฑ -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: #f39c12;">
                <h2>โ๏ธ ูุฑุงุด ุงุทูุงุนุงุช ูุดุชุฑ</h2>
                <button class="close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm" class="edit-form">
                    <input type="hidden" id="editCustomerId" name="id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editFullName">๐ค ูุงู ูุดุชุฑ:</label>
                            <input type="text" id="editFullName" name="full_name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editPhoneNumber">๐ ุดูุงุฑู ุชูุงุณ:</label>
                            <input type="tel" id="editPhoneNumber" name="phone_number" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editEntryDate">๐ ุชุงุฑุฎ ูุฑูุฏ:</label>
                            <div class="date-input-wrapper">
                                <input type="text" id="editEntryDate" name="entry_date" required 
                                       class="date-input"
                                       placeholder="1403/10/01"
                                       readonly
                                       onfocus="showPersianCalendar('editEntryDate')">
                                <button type="button" class="datepicker-btn" onclick="showPersianCalendar('editEntryDate')">
                                    ๐
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editExitDate">๐ ุชุงุฑุฎ ุฎุฑูุฌ:</label>
                            <div class="date-input-wrapper">
                                <input type="text" id="editExitDate" name="exit_date" 
                                       class="date-input"
                                       placeholder="ุงุฎุชุงุฑ - 1403/10/15"
                                       readonly
                                       onfocus="showPersianCalendar('editExitDate')">
                                <button type="button" class="datepicker-btn" onclick="showPersianCalendar('editExitDate')">
                                    ๐
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDeviceCode">๐ท๏ธ ฺฉุฏ ูุณูู:</label>
                            <input type="text" id="editDeviceCode" name="device_code" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editDeviceType">๐ง ููุน ูุณูู:</label>
                            <input type="text" id="editDeviceType" name="device_type" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editMaterialCost">๐ฐ ููุช ุฌูุณ (ุชููุงู):</label>
                            <input type="number" id="editMaterialCost" name="material_cost" class="currency" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="editServiceCost">๐ผ ุฏุณุชูุฒุฏ ุฎุฏูุงุช (ุชููุงู):</label>
                            <input type="number" id="editServiceCost" name="service_cost" class="currency" value="0">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="editDescription">๐ ุชูุถุญุงุช:</label>
                        <textarea id="editDescription" name="description" rows="3"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-warning">
                            ๐พ ุฐุฎุฑู ุชุบุฑุงุช
                        </button>
                        <button type="button" onclick="closeEditModal()" class="btn btn-secondary">
                            โ ุงูุตุฑุงู
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal ุจุฑุง ุชุงุฏ ุญุฐู -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: #e74c3c;">
                <h2>โ๏ธ ุชุงุฏ ุญุฐู</h2>
                <button class="close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="deleteMessage" style="text-align: center; font-size: 16px; margin-bottom: 20px;">
                    <!-- ูพุงู ุญุฐู ุงูุฌุง ููุงุด ุฏุงุฏู ูโุดูุฏ -->
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="confirmDelete" class="btn btn-danger">ุจููุ ุญุฐู ฺฉู</button>
                    <button onclick="closeDeleteModal()" class="btn btn-secondary">ุงูุตุฑุงู</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ุชููู ูุงุฑุณ ุจุฑุง ูุฑุงุด -->
    <div id="persianCalendar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>๐ ุชููู ูุงุฑุณ</h2>
                <button class="close" onclick="hidePersianCalendar()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="calendar-controls">
                    <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">โน ูุงู ูุจู</button>
                    <span id="calendarMonthYear" class="calendar-month">ุฏ 1403</span>
                    <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">ูุงู ุจุนุฏ โบ</button>
                </div>
                <div class="calendar-weekdays">
                    <div>ุด</div>
                    <div></div>
                    <div>ุฏ</div>
                    <div>ุณ</div>
                    <div>ฺ</div>
                    <div>ูพ</div>
                    <div>ุฌ</div>
                </div>
                <div id="calendarDays" class="calendar-days"></div>
                <div class="calendar-actions">
                    <button onclick="setCalendarToday()" class="btn btn-secondary">ุงูุฑูุฒ</button>
                    <button onclick="hidePersianCalendar()" class="btn btn-primary">ุจุณุชู</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ูุฏุฑุช Modalโูุง
        const modal = document.getElementById('customerModal');
        const editModal = document.getElementById('editModal');
        const deleteModal = document.getElementById('deleteModal');
        const closeBtn = document.querySelector('.close');

        let customerToDelete = null;

        function openModal() {
            modal.style.display = 'block';
            document.body.classList.add('modal-open');
        }

        function closeModal() {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function openEditModal() {
            editModal.style.display = 'block';
            document.body.classList.add('modal-open');
        }

        function closeEditModal() {
            editModal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function openDeleteModal() {
            deleteModal.style.display = 'block';
            document.body.classList.add('modal-open');
        }

        function closeDeleteModal() {
            deleteModal.style.display = 'none';
            document.body.classList.remove('modal-open');
            customerToDelete = null;
        }

        closeBtn.onclick = closeModal;

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == deleteModal) {
                closeDeleteModal();
            }
        }

        // ุจุณุชู Modal ุจุง ฺฉูุฏ ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeEditModal();
                closeDeleteModal();
            }
        });

        // ููุงุด ุงุทูุงุนุงุช ูุดุชุฑ
        async function showCustomerDetails(customerId) {
            try {
                const response = await fetch(`/api/customer/${customerId}`);
                const customer = await response.json();

                if (customer.success) {
                    displayCustomerDetails(customer.data);
                    openModal();
                } else {
                    showAlert('ุฎุทุง ุฏุฑ ุฏุฑุงูุช ุงุทูุงุนุงุช ูุดุชุฑ', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ', 'error');
            }
        }

        // ููุงุด ุงุทูุงุนุงุช ุฏุฑ Modal
        function displayCustomerDetails(customer) {
            const detailsContainer = document.getElementById('customerDetails');

            const formatCurrency = (amount) => {
                if (!amount) return 'ฐ ุชููุงู';
                return new Intl.NumberFormat('fa-IR').format(amount) + ' ุชููุงู';
            };

            const formatDate = (date) => {
                return date || '-';
            };

            detailsContainer.innerHTML = `
                <div class="detail-group">
                    <span class="detail-label">๐ค ูุงู ูุดุชุฑ:</span>
                    <div class="detail-value">${customer.full_name || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <span class="detail-label">๐ ุดูุงุฑู ุชูุงุณ:</span>
                    <div class="detail-value">${customer.phone_number || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <span class="detail-label">๐ ุชุงุฑุฎ ูุฑูุฏ:</span>
                    <div class="detail-value">${formatDate(customer.entry_date)}</div>
                </div>
                
                <div class="detail-group">
                    <span class="detail-label">๐ ุชุงุฑุฎ ุฎุฑูุฌ:</span>
                    <div class="detail-value ${!customer.exit_date ? 'empty' : ''}">
                        ${formatDate(customer.exit_date) || 'ุชุนู ูุดุฏู'}
                    </div>
                </div>
                
                <div class="detail-group">
                    <span class="detail-label">๐ท๏ธ ฺฉุฏ ูุณูู:</span>
                    <div class="detail-value">${customer.device_code || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <span class="detail-label">๐ง ููุน ูุณูู:</span>
                    <div class="detail-value">${customer.device_type || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <span class="detail-label">๐ฐ ููุช ุฌูุณ:</span>
                    <div class="detail-value">${formatCurrency(customer.material_cost)}</div>
                </div>
                
                <div class="detail-group">
                    <span class="detail-label">๐ผ ุฏุณุชูุฒุฏ ุฎุฏูุงุช:</span>
                    <div class="detail-value">${formatCurrency(customer.service_cost)}</div>
                </div>
                
                <div class="detail-group" style="grid-column: 1 / -1;">
                    <span class="detail-label">๐ต ูุฌููุน ูุฒูู:</span>
                    <div class="detail-value" style="background: #e8f5e8; color: #2d5016; font-weight: bold;">
                        ${formatCurrency(customer.total_cost)}
                    </div>
                </div>
                
                <div class="detail-group" style="grid-column: 1 / -1;">
                    <span class="detail-label">๐ ุชูุถุญุงุช:</span>
                    <div class="detail-value ${!customer.description ? 'empty' : ''}" style="min-height: 60px;">
                        ${customer.description || 'ุชูุถุญุงุช ุซุจุช ูุดุฏู ุงุณุช'}
                    </div>
                </div>
                
                <div class="detail-group" style="grid-column: 1 / -1;">
                    <span class="detail-label">๐ ุชุงุฑุฎ ุซุจุช:</span>
                    <div class="detail-value">${formatDate(customer.created_at)}</div>
                </div>
                
                <div class="detail-group" style="grid-column: 1 / -1; text-align: center; margin-top: 20px;">
                    <div class="action-buttons">
                        <button class="btn-edit" onclick="editCustomer(${customer.id})" style="font-size: 16px; padding: 10px 20px;">
                            โ๏ธ ูุฑุงุด ุงู ูุดุชุฑ
                        </button>
                        <button class="btn-delete" onclick="deleteCustomer(${customer.id}, '${customer.full_name}')" style="font-size: 16px; padding: 10px 20px;">
                            ๐๏ธ ุญุฐู ุงู ูุดุชุฑ
                        </button>
                    </div>
                </div>
            `;
        }

        // ูุฑุงุด ูุดุชุฑ
        async function editCustomer(customerId) {
            try {
                const response = await fetch(`/api/customer/${customerId}`);
                const result = await response.json();

                if (result.success) {
                    fillEditForm(result.data);
                    openEditModal();
                } else {
                    showAlert('ุฎุทุง ุฏุฑ ุฏุฑุงูุช ุงุทูุงุนุงุช ูุดุชุฑ ุจุฑุง ูุฑุงุด', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ', 'error');
            }
        }

        // ูพุฑ ฺฉุฑุฏู ูุฑู ูุฑุงุด
        function fillEditForm(customer) {
            document.getElementById('editCustomerId').value = customer.id;
            document.getElementById('editFullName').value = customer.full_name || '';
            document.getElementById('editPhoneNumber').value = customer.phone_number || '';
            document.getElementById('editEntryDate').value = customer.entry_date || '';
            document.getElementById('editExitDate').value = customer.exit_date || '';
            document.getElementById('editDeviceCode').value = customer.device_code || '';
            document.getElementById('editDeviceType').value = customer.device_type || '';
            document.getElementById('editMaterialCost').value = customer.material_cost || 0;
            document.getElementById('editServiceCost').value = customer.service_cost || 0;
            document.getElementById('editDescription').value = customer.description || '';
        }

        // ุงุฑุณุงู ูุฑู ูุฑุงุด
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            submitBtn.textContent = 'ุฏุฑ ุญุงู ุฐุฎุฑู...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/update-customer', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('โ ุงุทูุงุนุงุช ูุดุชุฑ ุจุง ููููุช ุจูโุฑูุฒุฑุณุงู ุดุฏ', 'success');
                    closeEditModal();
                    // ุฑูุฑุด ุตูุญู ุจุนุฏ ุงุฒ 1 ุซุงูู
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('โ ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('โ ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ', 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // ุญุฐู ูุดุชุฑ
        function deleteCustomer(customerId, customerName) {
            customerToDelete = customerId;
            const deleteMessage = document.getElementById('deleteMessage');
            deleteMessage.innerHTML = `
                <p>ุขุง ุงุฒ ุญุฐู ูุดุชุฑ ุฒุฑ ูุทูุฆู ูุณุชุฏุ</p>
                <p style="font-weight: bold; color: #e74c3c; margin: 10px 0;">${customerName}</p>
                <p style="color: #666; font-size: 14px;">ุงู ุนูู ุบุฑูุงุจู ุจุงุฒฺฏุดุช ุงุณุช!</p>
            `;
            
            const confirmBtn = document.getElementById('confirmDelete');
            confirmBtn.onclick = confirmDelete;
            
            openDeleteModal();
        }

        async function confirmDelete() {
            if (!customerToDelete) return;
            
            try {
                const response = await fetch(`/api/delete-customer/${customerToDelete}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('โ ูุดุชุฑ ุจุง ููููุช ุญุฐู ุดุฏ', 'success');
                    closeDeleteModal();
                    // ุฑูุฑุด ุตูุญู ุจุนุฏ ุงุฒ 1 ุซุงูู
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('โ ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('โ ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ', 'error');
            }
        }

        // ูพุงฺฉ ฺฉุฑุฏู ุฌุณุชุฌู
        function clearSearch() {
            window.location.href = '/customers';
        }

        // ุฎุฑูุฌ Excel
        function exportToExcel() {
            window.open('/api/export-excel', '_blank');
        }

        // ููุงุด ูพุงู
        function showAlert(message, type) {
            const existingAlerts = document.querySelectorAll('.custom-alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert alert-${type}`;
            alertDiv.innerHTML = `
                <div class="alert-content">
                    <span class="alert-icon">${type === 'success' ? 'โ' : 'โ'}</span>
                    <span class="alert-message">${message}</span>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 300);
            }, 5000);
        }

        // ูุญุงุณุจู ุขูุงุฑ
        document.addEventListener('DOMContentLoaded', function() {
            calculateStats();
            
            // ุฌุณุชุฌู ุฎูุฏฺฉุงุฑ
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        if (this.value.length >= 2 || this.value.length === 0) {
                            this.closest('form').submit();
                        }
                    }, 500);
                });
            }
        });

        function calculateStats() {
            const customers = {{ customers|tojson|safe }};
            let totalIncome = 0;
            let activeRepairs = 0;
            
            customers.forEach(customer => {
                if (customer[9] && customer[9] !== '') {
                    totalIncome += parseInt(customer[9]) || 0;
                }
                if (!customer[4]) {
                    activeRepairs++;
                }
            });
            
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('activeRepairs').textContent = activeRepairs;
        }

        function formatCurrency(number) {
            if (!number) return 'ฐ ุชููุงู';
            return new Intl.NumberFormat('fa-IR').format(number) + ' ุชููุงู';
        }

        // ูุชุบุฑูุง ุชููู ูุงุฑุณ
        let currentDateField = null;
        let calendarYear, calendarMonth, calendarDay;
        const persianMonths = [
            'ูุฑูุฑุฏู', 'ุงุฑุฏุจูุดุช', 'ุฎุฑุฏุงุฏ', 'ุชุฑ', 'ูุฑุฏุงุฏ', 'ุดูุฑูุฑ',
            'ููุฑ', 'ุขุจุงู', 'ุขุฐุฑ', 'ุฏ', 'ุจููู', 'ุงุณููุฏ'
        ];

        // ุงูฺฏูุฑุชู ุฏูู ุชุจุฏู ููุงุฏ ุจู ุดูุณ
        function gregorianToJalali(gy, gm, gd) {
            let g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            let jy = (gy <= 1600) ? 0 : 979;
            gy -= (gy <= 1600) ? 621 : 1600;
            let gy2 = (gm > 2) ? (gy + 1) : gy;
            let days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) 
                     + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
            jy += 33 * (parseInt(days / 12053));
            days %= 12053;
            jy += 4 * (parseInt(days / 1461));
            days %= 1461;
            jy += parseInt((days - 1) / 365);
            if (days > 365) days = (days - 1) % 365;
            let jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
            let jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
            return [jy, jm, jd];
        }

        // ฺฏุฑูุชู ุชุงุฑุฎ ุงูุฑูุฒ ุจู ุดูุณ
        function getTodayJalali() {
            const today = new Date();
            const [jy, jm, jd] = gregorianToJalali(
                today.getFullYear(), 
                today.getMonth() + 1, 
                today.getDate()
            );
            return { year: jy, month: jm, day: jd };
        }

        // ููุงุด ุชููู ูุงุฑุณ
        function showPersianCalendar(fieldId) {
            currentDateField = fieldId;
            
            // ุชูุธู ุชุงุฑุฎ ูุนู
            const today = getTodayJalali();
            calendarYear = today.year;
            calendarMonth = today.month;
            calendarDay = today.day;
            
            // ุงฺฏุฑ ููุฏ ููุฏุงุฑ ุฏุงุฑุฏุ ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉู
            const currentValue = document.getElementById(fieldId).value;
            if (currentValue) {
                const parts = currentValue.split('/');
                if (parts.length === 3) {
                    calendarYear = parseInt(parts[0]);
                    calendarMonth = parseInt(parts[1]);
                    calendarDay = parseInt(parts[2]);
                }
            }
            
            renderPersianCalendar();
            document.getElementById('persianCalendar').style.display = 'block';
            document.body.classList.add('modal-open');
        }

        function hidePersianCalendar() {
            document.getElementById('persianCalendar').style.display = 'none';
            document.body.classList.remove('modal-open');
            currentDateField = null;
        }

        function changeCalendarMonth(direction) {
            calendarMonth += direction;
            if (calendarMonth > 12) {
                calendarMonth = 1;
                calendarYear++;
            } else if (calendarMonth < 1) {
                calendarMonth = 12;
                calendarYear--;
            }
            renderPersianCalendar();
        }

        function renderPersianCalendar() {
            const monthYearElement = document.getElementById('calendarMonthYear');
            const daysElement = document.getElementById('calendarDays');
            
            monthYearElement.textContent = `${persianMonths[calendarMonth - 1]} ${calendarYear}`;
            daysElement.innerHTML = '';
            
            // ูุญุงุณุจู ุฑูุฒูุง ูุงู
            const daysInMonth = (calendarMonth <= 6) ? 31 : 30;
            const actualDaysInMonth = (calendarMonth === 12 && !isLeapYear(calendarYear)) ? 29 : daysInMonth;
            
            // ูุญุงุณุจู ุฑูุฒ ุงูู ูุงู
            const firstDay = getFirstDayOfMonth(calendarYear, calendarMonth);
            const today = getTodayJalali();
            
            // ุฎุงููโูุง ุฎุงู ูุจู ุงุฒ ุฑูุฒ ุงูู
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                daysElement.appendChild(emptyDay);
            }
            
            // ุฑูุฒูุง ูุงู
            for (let day = 1; day <= actualDaysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.onclick = function() {
                    selectCalendarDate(day);
                };
                
                // ุจุฑุฑุณ ุขุง ุงูุฑูุฒ ุงุณุช
                if (calendarYear === today.year && calendarMonth === today.month && day === today.day) {
                    dayElement.classList.add('today');
                }
                
                // ุจุฑุฑุณ ุขุง ุฑูุฒ ุงูุชุฎุงุจ ุดุฏู ุงุณุช
                if (calendarDay === day) {
                    dayElement.classList.add('selected');
                }
                
                daysElement.appendChild(dayElement);
            }
        }

        // ุจุฑุฑุณ ุณุงู ฺฉุจุณู
        function isLeapYear(jy) {
            const remains = [1, 5, 9, 13, 17, 22, 26, 30];
            return remains.includes(jy % 33);
        }

        // ูุญุงุณุจู ุฑูุฒ ุงูู ูุงู
        function getFirstDayOfMonth(jy, jm) {
            // ูุญุงุณุจู ุณุงุฏู - ุฏุฑ ูุงูุนุช ูุงุฒ ุจู ุงูฺฏูุฑุชู ุฏููโุชุฑ ุฏุงุฑุฏ
            return (jm * 2) % 7;
        }

        function selectCalendarDate(day) {
            calendarDay = day;
            const selectedDate = `${calendarYear}/${calendarMonth.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
            document.getElementById(currentDateField).value = selectedDate;
            hidePersianCalendar();
        }

        function setCalendarToday() {
            const today = getTodayJalali();
            calendarYear = today.year;
            calendarMonth = today.month;
            calendarDay = today.day;
            selectCalendarDate(calendarDay);
        }

        // ุจุณุชู modal ุจุง ฺฉูฺฉ ุฎุงุฑุฌ
        window.onclick = function(event) {
            const modal = document.getElementById('persianCalendar');
            if (event.target == modal) {
                hidePersianCalendar();
            }
        }

        // ุจุณุชู ุจุง ฺฉูุฏ ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                hidePersianCalendar();
            }
        });
    </script>
</body>
<!-- ููุชุฑ ุณุงุฏู - ฺฉุฏ ุงู ูุณูุช ุฑุง ุฏุฑ ุงูุชูุง body ููู ุตูุญุงุช ูุฑุงุฑ ุฏูุฏ -->
<footer class="simple-footer">
    <div class="footer-content">
        <div class="footer-text">
            <span class="version">ูุณุฎู ฑ.ฐ - ูุฎุตูุต ุงุณุชูุงุฏู ูุญู</span>
            <span class="separator">|</span>
            <span class="developer">
                ุจุฑูุงูู ููุณ: 
                <a href="mailto:m.vahdatfar@gmail.com" class="developer-link">
                    ูุญููุฏ ูุญุฏุช ูุฑ
                </a>
            </span>
        </div>
    </div>
</footer>
</html>