<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ - Ø³ÛŒØ³ØªÙ… ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡</title>
	<link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ˆ Ù†Ø±Ù… Ø§ÙØ²Ø§Ø± Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡ Ù„ÙˆØ§Ø²Ù… Ø®Ø§Ù†Ú¯ÛŒ Ú†Ø§Ø¨Ú© Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©</h1>
            <nav>
                <a href="/" class="nav-link">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
                <a href="/add-customer" class="nav-link">ğŸ‘¤ Ø«Ø¨Øª Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¬Ø¯ÛŒØ¯</a>
                <a href="/customers" class="nav-link">ğŸ“‹ Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒØ§Ù†</a>
                <a href="/reports" class="nav-link active">ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</a>
                <a href="/import-export" class="nav-link">ğŸ“¤ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª/Ø§Ú©Ø³Ù¾ÙˆØ±Øª</a>
            </nav>
        </header>

        <main>
            <div class="reports-section">
                <div class="section-header">
                    <div class="header-icon">ğŸ“Š</div>
                    <h2>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h2>
                    <p>ØªØ­Ù„ÛŒÙ„ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ø®Ø±ÙˆØ¬</p>
                </div>

                <!-- Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø±Ø¢Ù…Ø¯ Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ -->
                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon">ğŸ’°</div>
                        <h3>Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø±Ø¢Ù…Ø¯ Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</h3>
                    </div>
                    <div class="report-body">
                        <form id="dateRangeForm" class="date-range-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="start_date" class="form-label">
                                        <span class="label-icon">ğŸ“…</span>
                                        ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹
                                    </label>
                                    <div class="date-input-wrapper">
                                        <input type="text" id="start_date" name="start_date" required 
                                               class="date-input"
                                               placeholder="1403/10/01"
                                               readonly
                                               onfocus="showPersianCalendar('start_date')">
                                        <button type="button" class="datepicker-btn" onclick="showPersianCalendar('start_date')">
                                            ğŸ“…
                                        </button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="end_date" class="form-label">
                                        <span class="label-icon">ğŸ“…</span>
                                        ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†
                                    </label>
                                    <div class="date-input-wrapper">
                                        <input type="text" id="end_date" name="end_date" required 
                                               class="date-input"
                                               placeholder="1403/10/30"
                                               readonly
                                               onfocus="showPersianCalendar('end_date')">
                                        <button type="button" class="datepicker-btn" onclick="showPersianCalendar('end_date')">
                                            ğŸ“…
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-large">
                                <span class="btn-icon">ğŸ“ˆ</span>
                                Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú¯Ø²Ø§Ø±Ø´
                            </button>
                        </form>

                        <div id="reportResult" class="report-result">
                            <div class="result-header">
                                <h4>ğŸ“‹ Ù†ØªØ§ÛŒØ¬ Ú¯Ø²Ø§Ø±Ø´</h4>
                                <span id="reportDateRange" class="date-range-badge"></span>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-card primary">
                                    <div class="stat-icon">ğŸ‘¥</div>
                                    <div class="stat-info">
                                        <h3>ØªØ¹Ø¯Ø§Ø¯ Ù…Ø´ØªØ±ÛŒØ§Ù†</h3>
                                        <span class="stat-number" id="reportCustomerCount">0</span>
                                    </div>
                                </div>
                                
                                <div class="stat-card success">
                                    <div class="stat-icon">ğŸ’°</div>
                                    <div class="stat-info">
                                        <h3>Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„</h3>
                                        <span class="stat-number" id="reportTotalIncome">0 ØªÙˆÙ…Ø§Ù†</span>
                                    </div>
                                </div>
                                
                                <div class="stat-card warning">
                                    <div class="stat-icon">ğŸ“Š</div>
                                    <div class="stat-info">
                                        <h3>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‡Ø± ØªØ¹Ù…ÛŒØ±</h3>
                                        <span class="stat-number" id="reportAverageIncome">0 ØªÙˆÙ…Ø§Ù†</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ -->
                <div class="quick-reports">
                    <div class="report-header">
                        <h3>ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹</h3>
                    </div>
                    <div class="quick-report-cards">
                        <div class="quick-report-card" onclick="generateQuickReport('today')">
                            <div class="report-icon">ğŸ“…</div>
                            <h4>Ø§Ù…Ø±ÙˆØ²</h4>
                            <p>Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²</p>
                        </div>
                        
                        <div class="quick-report-card" onclick="generateQuickReport('week')">
                            <div class="report-icon">ğŸ“…</div>
                            <h4>Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ</h4>
                            <p>Ú¯Ø²Ø§Ø±Ø´ Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡</p>
                        </div>
                        
                        <div class="quick-report-card" onclick="generateQuickReport('month')">
                            <div class="report-icon">ğŸ“…</div>
                            <h4>Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</h4>
                            <p>Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡ Ø´Ù…Ø³ÛŒ Ø¬Ø§Ø±ÛŒ</p>
                        </div>
                        
                        <div class="quick-report-card" onclick="generateQuickReport('all')">
                            <div class="report-icon">ğŸ“Š</div>
                            <h4>Ù‡Ù…Ù‡ Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§</h4>
                            <p>Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø§Ø² Ø§Ø¨ØªØ¯Ø§</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ -->
    <div id="persianCalendar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“… ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ</h2>
                <button class="close" onclick="hidePersianCalendar()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="calendar-controls">
                    <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">â€¹ Ù…Ø§Ù‡ Ù‚Ø¨Ù„</button>
                    <span id="calendarMonthYear" class="calendar-month">Ø¯ÛŒ 1403</span>
                    <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ â€º</button>
                </div>
                <div class="calendar-weekdays">
                    <div>Ø´</div>
                    <div>ÛŒ</div>
                    <div>Ø¯</div>
                    <div>Ø³</div>
                    <div>Ú†</div>
                    <div>Ù¾</div>
                    <div>Ø¬</div>
                </div>
                <div id="calendarDays" class="calendar-days"></div>
                <div class="calendar-actions">
                    <button onclick="setCalendarToday()" class="btn btn-secondary">Ø§Ù…Ø±ÙˆØ²</button>
                    <button onclick="hidePersianCalendar()" class="btn btn-primary">Ø¨Ø³ØªÙ†</button>
                </div>
            </div>
        </div>
    </div>

 <script>
    // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ
    let currentDateField = null;
    let calendarYear, calendarMonth, calendarDay;
    const persianMonths = [
        'ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±',
        'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'
    ];

    // Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø¯Ù‚ÛŒÙ‚ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
    function gregorianToJalali(gy, gm, gd) {
        let g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        let jy = (gy <= 1600) ? 0 : 979;
        gy -= (gy <= 1600) ? 621 : 1600;
        let gy2 = (gm > 2) ? (gy + 1) : gy;
        let days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) 
                 + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
        jy += 33 * (parseInt(days / 12053));
        days %= 12053;
        jy += 4 * (parseInt(days / 1461));
        days %= 1461;
        jy += parseInt((days - 1) / 365);
        if (days > 365) days = (days - 1) % 365;
        let jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
        let jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
        return [jy, jm, jd];
    }

    // Ú¯Ø±ÙØªÙ† ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
    function getTodayJalali() {
        const today = new Date();
        const [jy, jm, jd] = gregorianToJalali(
            today.getFullYear(), 
            today.getMonth() + 1, 
            today.getDate()
        );
        return { year: jy, month: jm, day: jd };
    }

    // Ù†Ù…Ø§ÛŒØ´ ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ
    function showPersianCalendar(fieldId) {
        currentDateField = fieldId;
        
        // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® ÙØ¹Ù„ÛŒ
        const today = getTodayJalali();
        calendarYear = today.year;
        calendarMonth = today.month;
        calendarDay = today.day;
        
        // Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
        const currentValue = document.getElementById(fieldId).value;
        if (currentValue) {
            const parts = currentValue.split('/');
            if (parts.length === 3) {
                calendarYear = parseInt(parts[0]);
                calendarMonth = parseInt(parts[1]);
                calendarDay = parseInt(parts[2]);
            }
        }
        
        renderPersianCalendar();
        document.getElementById('persianCalendar').style.display = 'block';
        document.body.classList.add('modal-open');
    }

    function hidePersianCalendar() {
        document.getElementById('persianCalendar').style.display = 'none';
        document.body.classList.remove('modal-open');
        currentDateField = null;
    }

    function changeCalendarMonth(direction) {
        calendarMonth += direction;
        if (calendarMonth > 12) {
            calendarMonth = 1;
            calendarYear++;
        } else if (calendarMonth < 1) {
            calendarMonth = 12;
            calendarYear--;
        }
        renderPersianCalendar();
    }

    function renderPersianCalendar() {
        const monthYearElement = document.getElementById('calendarMonthYear');
        const daysElement = document.getElementById('calendarDays');
        
        monthYearElement.textContent = `${persianMonths[calendarMonth - 1]} ${calendarYear}`;
        daysElement.innerHTML = '';
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡
        const daysInMonth = (calendarMonth <= 6) ? 31 : 30;
        const actualDaysInMonth = (calendarMonth === 12 && !isLeapYear(calendarYear)) ? 29 : daysInMonth;
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ² Ø§ÙˆÙ„ Ù…Ø§Ù‡
        const firstDay = getFirstDayOfMonth(calendarYear, calendarMonth);
        const today = getTodayJalali();
        
        // Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÙˆØ² Ø§ÙˆÙ„
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            daysElement.appendChild(emptyDay);
        }
        
        // Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡
        for (let day = 1; day <= actualDaysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            dayElement.onclick = function() {
                selectCalendarDate(day);
            };
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒØ§ Ø§Ù…Ø±ÙˆØ² Ø§Ø³Øª
            if (calendarYear === today.year && calendarMonth === today.month && day === today.day) {
                dayElement.classList.add('today');
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒØ§ Ø±ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø§Ø³Øª
            if (calendarDay === day) {
                dayElement.classList.add('selected');
            }
            
            daysElement.appendChild(dayElement);
        }
    }

    // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ù„ Ú©Ø¨ÛŒØ³Ù‡
    function isLeapYear(jy) {
        const remains = [1, 5, 9, 13, 17, 22, 26, 30];
        return remains.includes(jy % 33);
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ² Ø§ÙˆÙ„ Ù…Ø§Ù‡
    function getFirstDayOfMonth(jy, jm) {
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¯Ù‡ - Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ÛŒ Ø¯Ø§Ø±Ø¯
        return (jm * 2) % 7;
    }

    function selectCalendarDate(day) {
        calendarDay = day;
        const selectedDate = `${calendarYear}/${calendarMonth.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
        document.getElementById(currentDateField).value = selectedDate;
        hidePersianCalendar();
    }

    function setCalendarToday() {
        const today = getTodayJalali();
        calendarYear = today.year;
        calendarMonth = today.month;
        calendarDay = today.day;
        selectCalendarDate(calendarDay);
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹
    async function loadQuickReports() {
        const types = ['today', 'week', 'month', 'all'];
        
        for (let type of types) {
            await generateQuickReport(type, true); // true ÛŒØ¹Ù†ÛŒ ÙÙ‚Ø· Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù† Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù†Ø¯Ù‡
        }
    }

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    async function generateQuickReport(type, autoLoad = false) {
        let startDate, endDate;
        const today = getTodayJalali();
        const todayString = `${today.year}/${today.month.toString().padStart(2, '0')}/${today.day.toString().padStart(2, '0')}`;
        
        switch(type) {
            case 'today':
                startDate = endDate = todayString;
                break;
            case 'week':
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ 7 Ø±ÙˆØ² Ù‚Ø¨Ù„
                const weekAgoDate = new Date();
                weekAgoDate.setDate(weekAgoDate.getDate() - 7);
                const weekAgo = gregorianToJalali(
                    weekAgoDate.getFullYear(),
                    weekAgoDate.getMonth() + 1,
                    weekAgoDate.getDate()
                );
                startDate = `${weekAgo[0]}/${weekAgo[1].toString().padStart(2, '0')}/${weekAgo[2].toString().padStart(2, '0')}`;
                endDate = todayString;
                break;
            case 'month':
                startDate = `${today.year}/${today.month.toString().padStart(2, '0')}/01`;
                endDate = todayString;
                break;
            case 'all':
                startDate = '1400/01/01';
                endDate = todayString;
                break;
        }
        
        // Ø§Ú¯Ø± autoLoad Ø¨Ø§Ø´Ø¯ØŒ ÙÙ‚Ø· Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù† Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù†Ø¯Ù‡
        if (autoLoad) {
            await calculateAndDisplayQuickStats(type, startDate, endDate);
            return;
        }
        
        // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø§ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
        document.getElementById('start_date').value = startDate;
        document.getElementById('end_date').value = endDate;
        
        // Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ±Ù… Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
        await submitReportRequest();
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ú¯Ø²Ø§Ø±Ø´ Ø³Ø±ÛŒØ¹
    async function calculateAndDisplayQuickStats(type, startDate, endDate) {
        try {
            const response = await fetch('/api/income-by-date', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate
                })
            });

            const result = await response.json();

            if (result.success) {
                // Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ø¯Ø± Ú©Ø§Ø±Øª Ù…Ø±Ø¨ÙˆØ·Ù‡
                const card = document.querySelector(`.quick-report-card:nth-child(${getCardIndex(type)})`);
                if (card) {
                    const statsElement = card.querySelector('.quick-stats') || createStatsElement(card);
                    statsElement.innerHTML = `
                        <div style="font-size: 12px; color: #27ae60; margin-top: 8px;">
                            <strong>${result.customer_count}</strong> Ù…Ø´ØªØ±ÛŒ | 
                            <strong>${formatCurrencyShort(result.total_income)}</strong>
                        </div>
                    `;
                }
            }
        } catch (error) {
            console.error('Error loading quick report:', error);
        }
    }

    // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ø¯Ú©Ø³ Ú©Ø§Ø±Øª
    function getCardIndex(type) {
        const types = ['today', 'week', 'month', 'all'];
        return types.indexOf(type) + 1;
    }

    // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ: Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù„Ù…Ø§Ù† Ø¢Ù…Ø§Ø± Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
    function createStatsElement(card) {
        const statsElement = document.createElement('div');
        statsElement.className = 'quick-stats';
        card.appendChild(statsElement);
        return statsElement;
    }

    // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ: ÙØ±Ù…Øª Ú©ÙˆØªØ§Ù‡ Ø§Ø±Ø²
    function formatCurrencyShort(number) {
        if (!number) return 'Û° ØªÙˆÙ…Ø§Ù†';
        return new Intl.NumberFormat('fa-IR').format(number) + ' ØªÙˆÙ…Ø§Ù†';
    }

    // ØªØ§Ø¨Ø¹ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú¯Ø²Ø§Ø±Ø´
    async function submitReportRequest() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if (!startDate || !endDate) {
            showAlert('Ù„Ø·ÙØ§Ù‹ Ù‡Ø± Ø¯Ùˆ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
            return;
        }

        const submitBtn = document.querySelector('#dateRangeForm button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<span class="btn-icon">â³</span> Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('/api/income-by-date', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate
                })
            });

            const result = await response.json();

            if (result.success) {
                displayReportResult(result);
                showAlert('Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯', 'success');
            } else {
                showAlert(result.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹...
    document.addEventListener('DOMContentLoaded', function() {
        const dateRangeForm = document.getElementById('dateRangeForm');
        
        dateRangeForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await submitReportRequest();
        });

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ ØµÙØ­Ù‡
        loadQuickReports();

        // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        setDefaultDates();
    });

    function displayReportResult(result) {
        const reportResult = document.getElementById('reportResult');
        reportResult.style.display = 'block';
        
        document.getElementById('reportCustomerCount').textContent = result.customer_count;
        document.getElementById('reportTotalIncome').textContent = formatCurrency(result.total_income);
        document.getElementById('reportAverageIncome').textContent = formatCurrency(
            result.customer_count > 0 ? Math.round(result.total_income / result.customer_count) : 0
        );
        document.getElementById('reportDateRange').textContent = 
            `${result.start_date} ØªØ§ ${result.end_date}`;
    }

    function setDefaultDates() {
        const today = getTodayJalali();
        const monthAgoDate = new Date();
        monthAgoDate.setDate(monthAgoDate.getDate() - 30);
        const monthAgo = gregorianToJalali(
            monthAgoDate.getFullYear(),
            monthAgoDate.getMonth() + 1,
            monthAgoDate.getDate()
        );
        
        document.getElementById('start_date').value = 
            `${monthAgo[0]}/${monthAgo[1].toString().padStart(2, '0')}/${monthAgo[2].toString().padStart(2, '0')}`;
        document.getElementById('end_date').value = 
            `${today.year}/${today.month.toString().padStart(2, '0')}/${today.day.toString().padStart(2, '0')}`;
    }

    function formatCurrency(number) {
        if (!number) return 'Û° ØªÙˆÙ…Ø§Ù†';
        return new Intl.NumberFormat('fa-IR').format(number) + ' ØªÙˆÙ…Ø§Ù†';
    }

    function showAlert(message, type) {
        const existingAlerts = document.querySelectorAll('.custom-alert');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `custom-alert alert-${type}`;
        alertDiv.innerHTML = `
            <div class="alert-content">
                <span class="alert-icon">${type === 'success' ? 'âœ…' : 'âŒ'}</span>
                <span class="alert-message">${message}</span>
            </div>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.classList.add('show');
        }, 100);
        
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 300);
        }, 5000);
    }

    // Ø¨Ø³ØªÙ† modal Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø®Ø§Ø±Ø¬
    window.onclick = function(event) {
        const modal = document.getElementById('persianCalendar');
        if (event.target == modal) {
            hidePersianCalendar();
        }
    }

    // Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒØ¯ ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            hidePersianCalendar();
        }
    });
</script>
</body>
<!-- ÙÙˆØªØ± Ø³Ø§Ø¯Ù‡ - Ú©Ø¯ Ø§ÛŒÙ† Ù‚Ø³Ù…Øª Ø±Ø§ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ body Ù‡Ù…Ù‡ ØµÙØ­Ø§Øª Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ -->
<footer class="simple-footer">
    <div class="footer-content">
        <div class="footer-text">
            <span class="version">Ù†Ø³Ø®Ù‡ Û±.Û° - Ù…Ø®ØµÙˆØµ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø­Ù„ÛŒ</span>
            <span class="separator">|</span>
            <span class="developer">
                Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³: 
                <a href="mailto:m.vahdatfar@gmail.com" class="developer-link">
                    Ù…Ø­Ù…ÙˆØ¯ ÙˆØ­Ø¯Øª ÙØ±
                </a>
            </span>
        </div>
    </div>
</footer>
</html>